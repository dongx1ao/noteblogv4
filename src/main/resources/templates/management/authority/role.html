<div class="layui-card layadmin-tabs-card">
    <div class="layui-card-header">
        <span class="layui-breadcrumb">
            <a href="/management/index">首页</a>
            <a><cite>角色管理</cite></a>
        </span>
    </div>
</div>

<div class="layui-fluid layadmin-container layui-anim-fadein" id="NB-role-tab">
    <div class="layui-row layui-col-space10">
        <div class="layui-col-sm4">
            <div class="layui-card">
                <div class="layui-card-header">角色信息列表</div>
                <div class="layui-card-body">
                    <table class="layui-table role-list" lay-skin="nob">
                        <tbody>
                        <tr v-for="(role,index) in roles" v-bind:class="{'select':role.id == selected}"
                            @click="selectRole(role.id,role.cnName)">
                            <td><i class="layui-icon layui-icon-username"></i> {{role.cnName}}</td>
                            <td class="layui-float-right"><i v-if="role.id == selected"
                                                             class="layui-icon layui-icon-ok"></i>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="layui-col-sm8">
            <div class="layui-card">
                <div class="layui-card-header">URL资源权限列表 - {{roleName}}</div>
                <div class="layui-card-body">
                    <form class="layui-form">
                        <div id="roleTree" style="width:100%;"></div>
                    </form>
                </div>
                <div class="layui-card-footer">
                    <button class="layui-btn layui-btn-sm" @click="subRes">提交</button>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
    .layui-table.role-list tr {
        cursor: pointer;
    }

    .layui-table.role-list tr.select {
        background: #f2f2f2;
    }
</style>
<script src="/static/plugins/layui-xtree/layui-xtree.js"></script>
<script th:inline="javascript">
    var roleTabApp = new Vue({
        el: "#NB-role-tab",
        data: {
            resTree: null,
            roles: [[${roleList}]]
            , selected: [[${roleList[0].id}]]
            , roleName: [[${roleList[0].cnName}]]
        },
        created: function () {
            window.__roleId = this.selected;
        },
        mounted: function () {
            layui.use(['form', 'element'], function () {
                var form = layui.form,
                    element = layui.element;

                element.render();
                roleTabApp.resTree = new layuiXtree({
                    elem: 'roleTree'   //(必填) 放置xtree的容器id，不要带#号
                    , form: form     //(必填) layui 的 from
                    , ckall: true
                    , icon: {        //三种图标样式，更改几个都可以，用的是layui的图标
                        end: "<i class='layui-icon layui-icon-template-1'></i>"      //末尾节点的图标
                    }
                    , data: BMY.url.prefix + '/resource/tree?roleId='
                });
            })
        }
        , methods: {
            selectRole: function (roleId, roleCnName) {
                roleTabApp.selected = roleId;
                window.__roleId = roleId;
                roleTabApp.roleName = roleCnName;
                roleTabApp.resTree.render();
            }
            , subRes: function () {
                var selectedInputs = roleTabApp.resTree.GetChecked();
                var resourceIds = [];
                for (var i = 0; i < selectedInputs.length; i++) {
                    resourceIds.push(selectedInputs[i].value);
                }
                $.post(BMY.url.prefix + '/update/role/resource', {
                    roleId: roleTabApp.selected,
                    resourceIds: resourceIds
                }, function (resp) {
                    layer.msg(resp.message);
                    if (resp.code === 200) {
                        roleTabApp.resTree.render();
                    }
                })
            }
        }
    })
</script>